# The image (microsoft/dotnet:2.1-sdk) which builds the code
FROM microsoft/dotnet:2.1-sdk AS build-env

LABEL maintainer="Stef Heyenrath"

WORKDIR /app

# copy csproj and restore as distinct layers
COPY ./latest ./
RUN dotnet restore src/StandAlone.NETCoreApp/StandAlone.NETCoreApp.latest.csproj

# copy everything else and build
COPY . ./
RUN dotnet build src/WireMock.Net/WireMock.Net.csproj -f netstandard2.0 -c Release -r linux-x64
RUN dotnet build src/WireMock.Net.StandAlone/WireMock.Net.StandAlone.csproj -f netstandard2.0 -c Release -r linux-x64
RUN dotnet publish src/StandAlone.NETCoreApp/StandAlone.NETCoreApp.latest.csproj -c Release -r linux-x64 -o out

# The image (microsoft/dotnet:2.1-runtime-deps) to create a runtime image
FROM microsoft/dotnet:2.1-runtime-deps
WORKDIR /app
COPY --from=build-env /app/src/StandAlone.NETCoreApp/out ./
EXPOSE 80
ENTRYPOINT ["./wiremock-net", "--Urls", "http://*:80", "--ReadStaticMappings", "false"]