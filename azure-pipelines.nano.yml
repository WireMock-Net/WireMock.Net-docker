variables:
  buildConfiguration: 'Release'
  imageNameNano: 'wiremock.net-nanoserver-$(nano-version)'
  buildProjects: '**/StandAlone.NETCoreApp.csproj'
  tag: '1.3.3'

trigger: none

jobs:
- job:
  displayName: Build and create Docker image (SelfHosted)
  pool: 
    name: 'MyBuildPool'

  steps:
  - task: DotNetCoreCLI@2
    displayName: Build StandAlone.NETCoreApp
    inputs:
      command: 'build'
      arguments: /p:Configuration=$(buildConfiguration)
      projects: $(buildProjects)

  - script: docker info
    displayName: 'Docker Info'

  - script: docker build -t $(DOCKER_ID)/$(imageNameNano) -f ./StandAlone.NETCoreApp/Dockerfile.nanoserver-$(nano-version) ./StandAlone.NETCoreApp
    displayName: 'Build Docker image [$(imageNameNano):latest]'

  - script: docker tag $(DOCKER_ID)/$(imageNameNano):latest $(DOCKER_ID)/$(imageNameNano):$(tag)
    displayName: 'Tag Docker image [$(imageNameNano):$(tag)]'

  - script: |
      docker login --username $(DOCKER_ID) --password $(DOCKER_PWD)
      docker push $(DOCKER_ID)/$(imageNameNano):latest
      docker push $(DOCKER_ID)/$(imageNameNano):$(tag)
    displayName: 'Push Docker image [$(imageNameNano)(latest,$(tag)]'

  - script: docker rmi $(DOCKER_ID)/$(imageNameNano)
    displayName: Delete Docker image [$(imageNameNano):latest]'

  - script: docker rmi $(DOCKER_ID)/$(imageNameNano):$(tag)
    displayName: Delete Docker image [$(imageNameNano):$(tag)]'

  - task: PowerShell@2
    displayName: Delete dangling Docker images
    targetType: inline
    arguments: docker rmi $(docker images --filter "dangling=true" --quiet)    